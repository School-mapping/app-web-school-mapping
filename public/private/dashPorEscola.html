<!DOCTYPE html>
<html lang="pt-br">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
<link rel="stylesheet" href="../css/dash.css" />
<link rel="stylesheet" href="../css/dashPorEscola.css" />
<link rel="stylesheet" href="../css/perfil.css">
<script src="../js/modal.js"></script>
<script src="../js/dashPorEscola.js"></script>
<link rel="stylesheet" href="../css/modal.css">
<link rel="stylesheet" href="../css/escolas.css" />

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash espec√≠fica</title>
</head>

<body>
    <aside class="barraLateral-esquerda">
        <img src="../assets/user.png" alt="" class="iconepessoa" />
        <div class="conteudo-central">

            <span id="nomeUser"></span>
            <span id="nomeEmpresa"></span>

            <nav class="menu-lateral">
                <a href="./dash.html" class="btn-menu">Home</a>
                <a href="./escolas.HTML" class="btn-menu">Escolas</a>
                <a href="./empresas.html" id="btn-empresa" class="btn-menu">Empresas</a>
                <a href="./configuracao.html" class="btn-menu">Configura√ß√£o</a>
                <a href="./perfil.html" class="btn-menu">Perfil</a>
                <a href="testechamados.html" class="btn-menu">Chamados</a>
                <a href="./listaNotificacoes.html" class="btn-menu">Lista Notifica√ß√µes</a>
                <a href="./perfil.html" class="btn-menu">Criar Notifica√ß√£o</a>


                <div id="modalChamado" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" onclick="fecharModal()">&times;</span>
                        <h2>Suporte Digital</h2>

                        <form>
                            <label for="nome" aria-placeholder="Insira seu nome">Nome:</label>
                            <input type="text" id="nome" name="nome" required>

                            <label for="assunto">Assunto:</label>
                            <input type="text" id="assunto" name="assunto" required>

                            <label for="descricao">Descri√ß√£o:</label>
                            <textarea id="descricao" name="descricao" required></textarea>

                            <label for="tipo">Tipo:</label>
                            <select id="tipo" name="tipo" required>
                                <option value="">Selecione uma op√ß√£o</option>
                                <option value="erro_dash">Erro de dashboard</option>
                                <option value="inconsistencia_dados">Inconsist√™ncia de Dados</option>
                                <option value="erro_graficos">Erro no Painel de Gr√°ficos</option>
                                <option value="erro_slack">Erro do Slack</option>
                                <option value="erro_escolas">Erro no Painel de Escolas</option>
                            </select>

                            <button type="submit">Enviar</button>
                        </form>
                    </div>
                </div>
                <a href="../login.html" class="btn-menu">Sair</a>
            </nav><ss="sair-section">

        </div>
    </aside>

    <Main class="conteudo">
        <div class="classHitorico">
            <span>  
                <a href="dash.html">Vis√£o Geral Municipal (IDEB)</a> >
                <a href="escolas.HTML">Escolas</a> > 
                <a id="escola-atual">-</a>
            </span>
            <button id="buttonCompararEscola">Comparar com melhor escola do ranking</button>
        </div>

        <div class="classKpis" id="divKpis">

            <div class="classKpi classKpi1">
                <div class="kpi-title">
                    IDEB atual <span class="kpi-ref-ano" >(-)</span>
                </div>
                <div class="kpi-value">
                    <span><span id="ideb-atual">(-)</span>
                    <a class="variacao-ideb" id="ideb-atual-variacao">(-)</a>
                </div>
                <div class="kpi-subtitle">üéØMeta: <span id="">7,0</span></div>

            </div>

            <div class="classKpi classKpi2">
                <div class="kpi-title">Repasse Financeiro - PTRF atual (R$)</div>
                <div class="kpi-value">
                    <span id="ptrf-atual">-</span>
                    <a class="variacao-ptrf" id="ptrf-atual-variacao">-</a>
                </div>
                <div class="kpi-subtitle">
                    Ano: <span class="kpi-ref-ano" >-</span></div>
            </div>

            <div class="classKpi classKpi3">
                <div class="kpi-title">Ranking de melhores escolas (IDEB)</div>
                <div class="kpi-value">
                    <span id="ranking-atual" class="kpi-ranking-atual">-</span>
                    <a id="variacao-ranking">-</a>
                </div>
                <div class="kpi-ref-ano">Ano: <span>-</span></div>
            </div>
        </div>

        <div class="classGraficoPrincipal">
            <canvas id="canvasGraficoPrincipal"></canvas>
        </div>

    </Main>

</body>

</html>

<Script>
    window.onload = function () {
        carregarNome();
        carregarPerfil();
        montarGrafico(sessionStorage.ID_ESCOLA)
    };
</Script>

<script>

    function carregarNome() {
        nomeUser.innerHTML = sessionStorage.USUARIO;
    }

    function carregarPerfil() {

        var id = sessionStorage.ID_USUARIO;

        fetch(`/perfil/carregarPerfil/${id}`, {
            method: "GET",
            cache: "no-store",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {

                if (resposta.ok) {
                    console.log('Busquei informa√ß√µes do perfil', resposta)
                    return resposta.json();

                } else {
                    throw "Erro ao buscar dados no data base";
                }
            })
            .then(function (perfilUser) {
                nomeEmpresa.innerHTML = perfilUser[0].razao_social;

                if (perfilUser[0].id_perfil == 1) {
                    document.getElementById("btn-empresa").style.display = "none";
                } else {
                    document.getElementById("btn-empresa").style.display = "block";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function montarGrafico(idEscola) {
        
        const ctx = document.getElementById('canvasGraficoPrincipal');

        carregarDadosDashboard(idEscola).then((resposta) => {

            const nome = resposta.nomeEscola;
            const anos = resposta.anosGerais;
            const ptrfs = resposta.ptrf;
            const idebs = resposta.ideb;

            plotarKpi(resposta);

            const mixedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: [
                        {
                            type: 'line',
                            label: 'Repasses Financeiros',
                            data: ptrfs,
                            yAxisID: 'RightY', // eixo da direita
                            borderColor: '#85BB65',
                            backgroundColor: '#85BB65',
                            tension: 0.3,
                            borderWidth: 4,
                            borderRadius: 6,
                            borderSkipped: false,
                        },
                        {
                            type: 'bar',
                            label: 'IDEB',
                            data: idebs,
                            yAxisID: 'LeftY', // eixo da esquerda
                            backgroundColor: '#4600C2',
                            borderColor: '#4600C2',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'IDEB e Repasses Financeiros (R$) no decorrer dos anos' },
                        legend: { display: true },
                        tooltip: { mode: 'index', intersect: false },
                        annotation: {
                            annotations: {
                                linhaMeta: {
                                    type: 'line',
                                    yMin: 7.0,
                                    yMax: 7.0,
                                    borderColor: '#d9534f',
                                    borderWidth: 3,
                                    borderDash: [10, 5], // Deixa a linha tracejada (10px tra√ßo, 5px espa√ßo)
                                    label: {
                                        enabled: true,
                                        content: 'Meta: 7,0',
                                        position: 'end',
                                        backgroundColor: 'rgba(217, 83, 79, 0.8)',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        LeftY: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Escala do IDEB'
                            }
                        },
                        RightY: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Repasses financeiros - PTRF'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        })
    
        carregarKpiRank(idEscola)

    }



</script>