<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estat√≠sticas - School Mapping</title>
  <link rel="stylesheet" href="../css/dash.css" />
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>

  <script>
    function formatarNumero(numero) {
      return numero.toFixed(1).replace('.', ',') + " / 10,0";
    }

    function calcularVariacao(atual, anterior) {
      if (anterior === 0) return 0;
      return ((atual - anterior) / anterior) * 100;
    }

    function formatarVariacao(variacao) {
      const elemento = document.getElementById('variacao-ideb');
      const valorFormatado = Math.abs(variacao).toFixed(1).replace('.', ',');

      if (variacao > 0) {
        elemento.innerHTML = `+${valorFormatado}%`;
        elemento.className = 'kpi-value positive';
      } else if (variacao < 0) {
        elemento.innerHTML = `-${valorFormatado}%`;
        elemento.className = 'kpi-value negative';
      } else {
        elemento.innerHTML = `${valorFormatado}%`;
        elemento.className = 'kpi-value neutral';
      }
    }

    function calcularMedia(array) {
      if (array.length === 0) return 0;
      const soma = array.reduce((a, b) => a + b, 0);
      return soma / array.length;
    }

    function carregarDadosIdeb() {
      const dataAtual = new Date();
      const anoAtual = 2025; // Ano fixo para coincidir com o gr√°fico
      const anoAnterior = 2023; // Ano fixo para coincidir com o gr√°fico

      document.getElementById('ano-atual').textContent = "(" + anoAtual + ")";
      document.getElementById('ano-anterior').textContent = "(" + anoAnterior + ")";

      // Usando os mesmos dados do gr√°fico de barras
      const dadosIdebAtual = [6.2, 7.0, 5.3, 3.3, 8.0]; // Valores de 2025 (atual)
      const dadosIdebAnterior = [6.8, 7.6, 6.3, 5.3, 8.5]; // Valores de 2023 (anterior)

      const mediaAtual = calcularMedia(dadosIdebAtual);
      const mediaAnterior = calcularMedia(dadosIdebAnterior);
      const variacao = calcularVariacao(mediaAtual, mediaAnterior);

      document.getElementById('ideb-atual').textContent = formatarNumero(mediaAtual);
      document.getElementById('ideb-anterior').textContent = formatarNumero(mediaAnterior);
      formatarVariacao(variacao);
    }

    document.addEventListener('DOMContentLoaded', function () {
      carregarDadosIdeb();
    });
  </script>
</head>

<body onload="carregarNome()">
  <div class="dashboard">
    <aside class="barraLateral-esquerda">
      <img src="../assets/user.png" alt="" class="iconepessoa" />
      <div class="conteudo-central">

        <span id="nomeUser"></span>

        <nav class="menu-lateral">
          <a href="./dash.html" class="btn-menu">Home</a>
          <a href="./escolas.HTML" class="btn-menu">Escolas</a>
          <a href="./configuracao.html" class="btn-menu">Configura√ß√£o</a>
        </nav><ss="sair-section">
          <a href="#" class="btn-menu">Sair</a><!-- Adicionr fun√ß√£o de encerramento de se√ß√£o -->

      </div>
    </aside>

    <main class="conteudo">

      <div class="classHitorico">
        <div class="">Vis√£o Geral Municipal (IDEB)</div>
      </div>

      <div class="linha-graficos linha1">
        <div class="kpis">
          
          <div class="grafico kpi">
            <div class="kpi-title">M√©dia IDEB
            </div>
            <div class="kpi-value">
              <span id="ideb-atual">-</span>
              <span class="kpi-ref-ano" id="ano-atual">-</span>
            </div>
            <div class="kpi-subtitle">üéØMeta: <span id="">7,0</span></div>

          </div>

          <div class="grafico kpi">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div class="kpi-title">Verba Destinada ao Municipio</div>
              <div class="kpi-value">R$ 253.200.000</div>
              <div class="kpi-subtitle">Ano: <span>2025</span></div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div class="kpi-title">Varia√ß√£o</div>
              <div class="kpi-value" style="color: green;">+R$ 25.200.000</div>
              <div class="kpi-subtitle">Em rela√ß√£o ao ano anterior</div>
            </div>
          </div>

          <div class="grafico kpi">
            <div class="kpi-title">M√©dia IDEB
            </div>
            <div class="kpi-value">
              <span id="ideb-anterior">-</span>
              <span class="kpi-ref-ano" id="ano-anterior">-</span>
            </div>
            <div class="kpi-subtitle">üéØMeta: <span id="">7,0</span></div>
          </div>

          <div class="grafico kpi">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div class="kpi-title">M√©dia IDEB Atual</div>
              <div class="kpi-value" id="ideb-atual">-</div>
              <div class="kpi-subtitle">Ano: <span id="ano-atual">-</span></div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div class="kpi-title">Varia√ß√£o</div>
              <div class="kpi-value" id="variacao-ideb">-</div>
              <div class="kpi-subtitle">Em rela√ß√£o ao ano anterior</div>
            </div>
          </div>

        </div>

        <div class="grafico">
          <canvas id="graficoBarras"></canvas>
        </div>
      </div>

      <div class="linha-graficos linha2">
        <div class="grafico">
          <h2 style="font-weight: 200; color: gray; font-size: 15px;">
            Mapa de Calor do IDEB por Estado
          </h2>
          <div id="mapaCalorGeo" style="width: 100%; height: 100%;"></div>

        </div>

        <div class="grafico">
          <canvas id="graficoBarras2"></canvas>
        </div>
      </div>

    </main>
  </div>

</body>

</html>

<script>
  function carregarNome() {
    nomeUser.innerHTML = sessionStorage.USUARIO;
  }
</script>

<!-- Gr√°ficos gerais -->
<script>
  // Grafico de barras - Zonas
  const ctx = document.getElementById('graficoBarras');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Zona Sul', 'Zona Leste', 'Zona Oeste', 'Zona Norte', 'Centro'],
      datasets: [{
        label: 'IDEB (2023)',
        data: [6.8, 7.6, 6.3, 5.3, 8.5],
        backgroundColor: '#4600C2',
        borderRadius: 6,
        borderSkipped: false
      }, {
        label: 'IDEB (2025)',
        data: [6.2, 7.0, 5.3, 3.3, 8.0],
        backgroundColor: '#000AC2',
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      grouped: true,
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'M√©dia do IDEB por zona em compara√ß√£o ao ano anterior' },
        legend: { display: true },
        tooltip: { mode: 'index', intersect: false },
        annotation: {
          annotations: {
            linhaMeta: {
              type: 'line',
              yMin: 7.0,
              yMax: 7.0,
              borderColor: '#d9534f',
              borderWidth: 3,
              borderDash: [10, 5], // Deixa a linha tracejada (10px tra√ßo, 5px espa√ßo)
              label: {
                enabled: true,
                content: 'Meta: 7,0',
                position: 'end',
                backgroundColor: 'rgba(217, 83, 79, 0.8)',
                font: {
                  weight: 'bold'
                }
              }
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.06)' },
          ticks: { precision: 0 }
        }
      }
    }
  });

  // Gr√°fico de barra - Bidirecional
  const ctxBarras2 = document.getElementById('graficoBarras2');

  const config = {
    type: 'bar',
    data: {
      labels: ['Zona Sul', 'Zona Leste', 'Zona Oeste', 'Zona Norte', 'Centro'],
      datasets: [
        {
          label: 'Nota m√©dia (IDEB)',
          data: [6.2, 7.0, 5.3, 3.3, 8.0],
          backgroundColor: '#4600C2',
          borderRadius: 6,
        },
        {
          label: 'Verba (R$ mil)',
          data: [-62, -70, -53, -33, -80],
          backgroundColor: '#85BB65',
          borderRadius: 6,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        title: {
          display: true,
          text: 'Compara√ß√£o de verba e notas por zona'
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              label += Math.abs(context.parsed.x);
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          offset: false,
          ticks: {
            callback: function (value, index, values) {
              return Math.abs(value);
            }
          },
          title: {
            display: true,
            text: 'Valor'
          },
          grid: {
            display: true,
            drawOnChartArea: true,
            drawTicks: true,
            color: function (context) {
              if (context.tick.value === 0) {
                return 'rgba(0, 0, 0, 0.6)';
              }
              return 'rgba(0, 0, 0, 0.1)';
            }
          },
          min: -85,
          max: 10,
        },
        y: {
          stacked: true,
          title: {
            display: true,
            text: 'Zonas'
          },
          grid: {
            drawOnChartArea: false,
            drawTicks: true
          }
        }
      }
    }
  };

  const myChart = new Chart(ctxBarras2, config);

</script>

<!-- Mapa de calor -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZDPpXaJeeEDVazesF8nBZONca1a8cwbE&callback=initMap"></script>
<script>
  // Mapa de calor
  async function initMap() {

    try {

      const response = await fetch("../geojsons/subprefeituras-sp.geojson");
      if (!response.ok) {
        throw new Error('N√£o foi poss√≠vel carregar o GeoJSON!');
      }

      const bounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(-24.20, -47.00),
        new google.maps.LatLng(-23.30, -46.20)
      );

      const geojson = response.json();

      const mapOptions = {
        zoom: 9,
        center: { lat: -23.55, lng: -46.63 },
        mapTypeId: google.maps.MapTypeId.SATELLITE,
        disableDoubleClickZoom: true,
        streetViewControl: false,
        mapTypeControl: false,
        restriction: {
          latLngBounds: bounds,
          strictBounds: false,
        },
        labels: false
      };

      var map = new google.maps.Map(document.getElementById('mapaCalorGeo'), mapOptions);

      map.data.loadGeoJson("../geojsons/subprefeituras-sp.geojson");
      map.data.setStyle(feature => {
        const ideb = parseFloat(feature.getProperty('ideb'));
        let cor;
        if (ideb < 6.5) {
          cor = '#FF0000'; // vermelho
        } else if (ideb < 8.3) {
          cor = '#FFA500'; // laranja
        } else {
          cor = '#00FF00'; // verde
        }
        return {
          fillColor: cor,
          strokeWeight: 1,
          fillOpacity: 0.85,
          strokeColor: '#333',
        };
      });

      map.data.addListener("click", function (event) {
        const nome = event.feature.getProperty("name");
        const ideb = event.feature.getProperty("ideb");

        const infoWindow = new google.maps.InfoWindow({
          content: `
          <div style="font-size:16px; font-weight:bold;">${nome}</div>
          <div style="margin-top:8px;">IDEB: ${ideb}</div>
          <div>Meta: 7.5</div>
          `,
          position: event.latLng
        });
        infoWindow.open(map);
      });
    } catch (error) {
      console.error(error);
    }
  }
</script>