<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estat√≠sticas - School Mapping</title>
  <link rel="stylesheet" href="../css/dash.css" />
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script src="../js/modal.js"></script>
  <script src="../js/dash.js"></script>
  <link rel="stylesheet" href="../css/modal.css">
  <link rel="stylesheet" href="../css/perfil.css">
  <link rel="stylesheet" href="../css/escolas.css" />
  <link rel="stylesheet" href="../css/dash.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
</head>

<body">
  <div class="dashboard">
    <aside class="barraLateral-esquerda">
      <img src="../assets/user.png" alt="" class="iconepessoa" />
      <div class="conteudo-central">

        <span id="nomeUser"></span>
        <span id="nomeEmpresa"></span>

        <nav class="menu-lateral">
          <a href="./dash.html" class="btn-menu">Home</a>
          <a href="./escolas.HTML" class="btn-menu">Escolas</a>
          <a href="./empresas.html" class="btn-menu" id="btn-empresa">Empresas</a>
          <a href="./configuracao.html" class="btn-menu">Configura√ß√£o</a>
          <!-- <a href="./perfil.html" class="btn-menu">Perfil</a> -->
          <a href="chamados.html" class="btn-menu">Chamados</a>
          <a href="./listaNotificacoes.html" class="btn-menu">Lista Notifica√ß√µes</a>
          <a href="./criarNotificacoes.html" class="btn-menu">Criar Notifica√ß√£o</a>

          <div id="modalChamado" class="modal" style="display:none;">
            <div class="modal-content">
              <span class="close" onclick="fecharModal()">&times;</span>
              <h2>Suporte Digital</h2>

              <form>
                <label for="nome" aria-placeholder="Insira seu nome">Nome:</label>
                <input type="text" id="nome" name="nome" required>

                <label for="assunto">Assunto:</label>
                <input type="text" id="assunto" name="assunto" required>

                <label for="descricao">Descri√ß√£o:</label>
                <textarea id="descricao" name="descricao" required></textarea>

                <label for="tipo">Tipo:</label>
                <select id="tipo" name="tipo" required>
                  <option value="">Selecione uma op√ß√£o</option>
                  <option value="erro_dash">Erro de dashboard</option>
                  <option value="inconsistencia_dados">Inconsist√™ncia de Dados</option>
                  <option value="erro_graficos">Erro no Painel de Gr√°ficos</option>
                  <option value="erro_slack">Erro do Slack</option>
                  <option value="erro_escolas">Erro no Painel de Escolas</option>
                </select>

                <button type="submit">Enviar</button>
              </form>
            </div>
          </div>

          <a class="btn-menu" onclick="logout()">Sair</a>
        </nav><ss="sair-section">

      </div>
    </aside>

    <main class="conteudo">

      <div class="classHitorico">
        <div class="">Vis√£o Geral Municipal (IDEB)</div>
      </div>

      <div class="linha-graficos linha1">

        <div class="kpis">
          <div class="kpi-line kpi-line-up">
            <div class="grafico kpi">
              <div class="kpi-title">M√©dia IDEB
              </div>
              <div class="kpi-value">
                <span id="ideb-atual">-</span>
                <span class="kpi-ref-ano" id="ano-atual">-</span>
              </div>
              <div class="kpi-subtitle">üéØMeta: <span id="">7,0</span></div>

            </div>

            <div class="grafico kpi">
              <span class="kpi-title">M√©dia IDEB</span>
              <div class="kpi-value">
                <span id="ideb-anterior">-</span>
                <span class="kpi-ref-ano" id="ano-anterior">-</span>
              </div>
              <div class="kpi-subtitle">üéØMeta: <span id="">7,0</span></div>
            </div>

            <div class="grafico kpi">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="kpi-title">Varia√ß√£o</div>
                <div class="kpi-value" id="variacao-ideb">-</div>
                <div class="kpi-subtitle">Em rela√ß√£o ao ano anterior</div>
              </div>
            </div>
          </div>

          <div class="kpi-line kpi-line-bottom">

            <div class="grafico kpi">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="kpi-title">Verba Destinada ao Municipio <span class="kpi-ref-ano"
                    id="ano-atual-ptrf">-</span></div>
                <div class="kpi-value">
                  <span id="atual-soma-ptrf">-</span>
                </div>
              </div>
            </div>

            <div class="grafico kpi">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="kpi-title">Verba Destinada ao Municipio <span class="kpi-ref-ano"
                    id="ano-anterior-ptrf">-</span></div>
                <div class="kpi-value">
                  <span id="anterior-soma-ptrf">-</span>
                </div>
              </div>
            </div>

            <div class="grafico kpi">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="kpi-title">Varia√ß√£o</div>
                <div class="kpi-value" id="variacao-ptrf">-</div>
                <div class="kpi-subtitle">Em rela√ß√£o ao ano anterior</div>
              </div>
            </div>

          </div>

        </div>

        <div class="grafico">
          <canvas id="graficoBarras"></canvas>
        </div>
      </div>

      <div class="linha-graficos linha2">
        <div class="grafico">
          <h2 style="font-weight: 200; color: gray; font-size: 15px;">
            Mapa de Calor do IDEB por Estado
          </h2>
          <div id="mapaCalorGeo" style="width: 100%; height: 100%;"></div>

        </div>

        <div class="grafico">
          <canvas id="graficoBarras2"></canvas>
        </div>
      </div>
  </div>

  </main>
  </div>

  </body>

</html>

<script>
  window.onload = function () {
    carregarNome();
    carregarPerfil();
    carregarDadosIdeb();
    carregarDadosPtrf();
  };
</script>

<!-- Pessoais -->
<script>
  function carregarNome() {
    nomeUser.innerHTML = sessionStorage.USUARIO;
  }

  function carregarPerfil() {

    var id = sessionStorage.ID_USUARIO;

    fetch(`/perfil/carregarPerfil/${id}`, {
      method: "GET",
      cache: "no-store",
      headers: {
        "Content-Type": "application/json",
      }
    })
      .then(function (resposta) {
        console.log(resposta);

        if (resposta.ok) {
          console.log('Busquei informa√ß√µes do perfil', resposta)
          return resposta.json();

        } else {
          throw "Erro ao buscar dados no data base";
        }
      })
      .then(function (perfilUser) {
        console.log(perfilUser[0].id_perfil)
        console.log(perfilUser[0].razao_social)
        nomeEmpresa.innerHTML = perfilUser[0].razao_social;

        if (perfilUser[0].id_perfil == 1) {
          document.getElementById("btn-empresa").style.display = "none";
        } else {
          document.getElementById("btn-empresa").style.display = "block";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }
</script>

<!-- Gr√°ficos gerais -->
<script>
  // Grafico de barras - Zonas
  const ctx = document.getElementById('graficoBarras');

  carregarGraficoBarra()
    .then(resultado => {
      const dadosBarra = resultado.dadosBarra;
      const anos = resultado.anos;

      console.log("Log: " + dadosBarra)

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dadosBarra[2],
          datasets: [{
            label: `IDEB (` + anos[0] + `)`,
            data: dadosBarra[0],
            backgroundColor: '#4600C2',
            borderRadius: 6,
            borderSkipped: false
          }, {
            label: `IDEB (` + anos[1] + `)`,
            data: dadosBarra[1],
            backgroundColor: '#000AC2',
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          grouped: true,
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'M√©dia do IDEB por zona em compara√ß√£o ao ano anterior' },
            legend: { display: true },
            tooltip: { mode: 'index', intersect: false },
            annotation: {
              annotations: {
                linhaMeta: {
                  type: 'line',
                  yMin: 7.0,
                  yMax: 7.0,
                  borderColor: '#d9534f',
                  borderWidth: 3,
                  borderDash: [10, 5], // Deixa a linha tracejada (10px tra√ßo, 5px espa√ßo)
                  label: {
                    enabled: true,
                    content: 'Meta: 7,0',
                    position: 'end',
                    backgroundColor: 'rgba(217, 83, 79, 0.8)',
                    font: {
                      weight: 'bold'
                    }
                  }
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.06)' },
              ticks: { precision: 0 }
            }
          }
        }
      });
    })


  // Gr√°fico de barra - Bidirecional
  const ctxBarras2 = document.getElementById('graficoBarras2');

  carregarGraficoBidirecional()
    .then(dados => {

      const dadosBidirecional = dados.dadosBidirecional;
      const ano = dados.ano;

      const notas = dadosBidirecional[0];
      const verbas = dadosBidirecional[1];
      const zonas = dadosBidirecional[2];

      const config = {
        type: 'bar',
        data: {
          labels: zonas,
          datasets: [
            {
              label: 'Nota m√©dia (IDEB)',
              data: notas,
              backgroundColor: '#4600C2',
              borderRadius: 6,
              yAxisID: 'LeftY',
            },
            {
              label: 'Verba (R$ Mil)',
              data: verbas,
              backgroundColor: '#85BB65',
              borderRadius: 6,
              yAxisID: 'RightY',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'IDEB e Verba por Zona (Escalas Duplas)'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.dataset.yAxisID === 'RightY') {
                    const valor = context.parsed.y;
                    return `R$ ${valor.toLocaleString('pt-BR')} Mil`;
                  }
                  return label + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false }
            },
            LeftY: {
              type: 'linear',
              position: 'left',
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'IDEB (0-10)'
              },
              grid: { color: 'rgba(0,0,0,0.06)' }
            },
            RightY: {
              type: 'linear',
              position: 'right',
              beginAtZero: true,
              max: 350,
              title: {
                display: true,
                text: 'Verba (R$ Mil)'
              },
              ticks: {
                callback: function (value) {
                  return `R$ ${value.toLocaleString('pt-BR')}`;
                }
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      };

      const myChart = new Chart(ctxBarras2, config);
    })



</script>

<!-- Mapa de calor -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZDPpXaJeeEDVazesF8nBZONca1a8cwbE&callback=initMap"></script>
<script>
  // Mapa de calor
  async function initMap() {

    try {
      const response = await fetch("../geojsons/subprefeituras-sp.geojson");
      if (!response.ok) {
        throw new Error('N√£o foi poss√≠vel carregar o GeoJSON!');
      }

      const bounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(-24.20, -47.00),
        new google.maps.LatLng(-23.30, -46.20)
      );

      const geojson = response.json();

      const mapOptions = {
        zoom: 9,
        center: { lat: -23.55, lng: -46.63 },
        mapTypeId: google.maps.MapTypeId.SATELLITE,
        disableDoubleClickZoom: true,
        streetViewControl: false,
        mapTypeControl: false,
        restriction: {
          latLngBounds: bounds,
          strictBounds: false,
        },
        labels: false
      };

      var map = new google.maps.Map(document.getElementById('mapaCalorGeo'), mapOptions);

      map.data.loadGeoJson("../geojsons/subprefeituras-sp.geojson");
      map.data.setStyle(feature => {
        const ideb = parseFloat(feature.getProperty('ideb'));
        let cor;
        if (ideb < 6.5) {
          cor = '#FF0000'; // vermelho
        } else if (ideb < 8.3) {
          cor = '#FFA500'; // laranja
        } else {
          cor = '#00FF00'; // verde
        }
        return {
          fillColor: cor,
          strokeWeight: 1,
          fillOpacity: 0.85,
          strokeColor: '#333',
        };
      });

      map.data.addListener("click", function (event) {
        const nome = event.feature.getProperty("name");
        const ideb = event.feature.getProperty("ideb");

        const infoWindow = new google.maps.InfoWindow({
          content: `
          <div style="font-size:16px; font-weight:bold;">${nome}</div>
          <div style="margin-top:8px;">IDEB: ${ideb}</div>
          <div>Meta: 7.5</div>
          `,
          position: event.latLng
        });
        infoWindow.open(map);
      });
    } catch (error) {
      console.error(error);
    }
  }

  function logout() {
    sessionStorage.clear();
    window.location = "../login.html";
  }
</script>